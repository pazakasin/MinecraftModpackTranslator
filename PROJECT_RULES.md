# プロジェクト手順ルール v2.10

## 📋 目的
このドキュメントは、Minecraft ModPack 日本語翻訳ツールの開発における、AI支援での出力ルールを定義します。

---

## 1. アーティファクトの命名規則

### 1.1 Javaソースコード
```
形式: <クラス名>.java
例: 
  - ModPackTranslatorGUI.java
  - TranslationService.java
  - SettingsDialog.java
```

### 1.2 設定ファイル
```
形式: 元のファイル名を維持
例:
  - pom.xml
  - translator_settings.properties
```

### 1.3 ドキュメント
```
形式: 内容に応じた明確な名前
例:
  - README.md
  - tool_design_document.md
  - PROJECT_RULES.md
```

---

## 2. 出力フロー

### 2.1 要約から開始するケース

#### A. コード生成の場合

以下の条件に該当する場合、**まず要約情報を出力**：

- ✅ 100行以上の新規コード
- ✅ 複数ファイルの同時変更
- ✅ アーキテクチャの大規模変更
- ✅ 新機能の実装

**要約の内容:**
```markdown
## 変更概要

### 影響範囲
- ファイル1: 変更内容
- ファイル2: 変更内容

### 主要な変更点
1. 変更ポイント1
2. 変更ポイント2
3. 変更ポイント3

### 推定行数: XXX行

この内容で詳細コードを生成しますか？
```

#### B. ドキュメント生成の場合

以下の条件に該当する場合、**まず目次・構成を出力**：

- ✅ 1000文字以上の文書
- ✅ 5ステップ以上の手順書
- ✅ セットアップガイド・チュートリアル
- ✅ 技術仕様書・設計書
- ✅ 複数セクションにわたる説明

**要約の内容:**
```markdown
## 📋 ドキュメント構成案

### タイトル
[ドキュメントタイトル]

### 対象読者
[想定読者]

### 📑 目次
1. セクション1
2. セクション2
3. セクション3
   3.1 サブセクション
   3.2 サブセクション

### 推定文字数: 約XXXX文字
### 推定読了時間: XX分

この構成で詳細を出力しますか？
または構成の調整が必要ですか？
```

---

---

### 2.3 作業前の確認

#### 情報確認の原則
作業に入る前に、不足している情報や曖昧な点があればすべて質問する。

#### 確認すべき項目の例
- **コード生成時**
  - 対象クラス・メソッドの特定
  - 実装の詳細仕様
  - エラーハンドリングの方針
  - 既存コードとの統合方法
  
- **ドキュメント生成時**
  - 対象読者のレベル
  - 記載すべき内容の範囲
  - 形式・スタイルの要望
  
- **リファクタリング時**
  - 変更の影響範囲
  - 後方互換性の要否
  - テストの実施可否

#### 質問の形式
```
## 作業開始前の確認

以下の点について確認させてください：
1. [質問1]
2. [質問2]
3. [質問3]

回答いただき次第、作業を開始します。
```

#### ユーザー側の協力
- 質問に対して明確に回答する
- 「任せます」の場合は、AIの判断で進めることを了承
- 後で変更が必要になった場合も、再度質問から始める

---

### 2.4 直接出力するケース

以下の場合は**要約なしで直接出力可**：

#### コード
- ⚡ 20行未満の修正
- ⚡ 単一メソッドの追加・修正
- ⚡ バグフィックス
- ⚡ 設定ファイルの小規模更新

#### ドキュメント
- ⚡ 500文字未満の説明
- ⚡ 単一トピックの回答
- ⚡ FAQ的な短い回答
- ⚡ 既存文書の小規模修正

#### その他
- ⚡ 明示的に「詳細を直接出力」と指示された場合
- ⚡ 緊急性の高い問い合わせ
- ⚡ 確認・検証が主目的の質問

---

## 3. トークン節約戦略

### 3.1 基本方針
```
目標: 必要な情報を効率的に提供しつつ、トークン消費を最小化
```

### 3.2 具体的手法

#### コード出力時
- 📌 長いコードは段階的に分割提案
- 📌 既存コードの引用は最小限に（変更箇所のみ）
- 📌 差分形式での提示を優先
- 📌 コメントは必要最小限

#### ドキュメント出力時
- 📌 目次による構造化を優先
- 📌 セクション単位での段階的出力
- 📌 冗長な説明を避け、簡潔に
- 📌 必要に応じて「詳細は後述」を活用

#### 例・サンプルコード
- 📌 重要な部分のみ掲載
- 📌 「...（省略）...」を適切に使用
- 📌 全体像は構造説明で補完

---

## 4. 出力品質基準

### 4.1 コードの品質
- ✅ Java 17互換
- ✅ 既存コードスタイルとの一貫性
- ✅ 適切なエラーハンドリング
- ✅ **JavaDoc の必須付与**
  - すべてのクラスに適切なJavaDoc
  - すべてのpublicメソッドに適切なJavaDoc
  - すべてのフィールドに適切なJavaDoc（private含む）
  - パラメータ、戻り値、例外の説明を含む
- ✅ **クラス・インタフェースの定義**
  - すべてのクラス、インタフェースは個別のファイルで定義
  - 内部クラス（inner class）の使用禁止
  - 内部インタフェース（inner interface）の使用禁止
  - 1ファイル = 1クラス/インタフェースの原則を厳守
- ✅ **ラムダ式の使用方針**
  - 原則として使用しない（従来の匿名クラスを優先）
  - 例外: ラムダ式を採用したほうが極端にコードが分かりやすくなる場合

### 4.2 ドキュメントの品質
- ✅ Markdown形式
- ✅ 明確な階層構造
- ✅ 具体例の提示
- ✅ 読みやすい文体

### 4.3 JavaDoc ガイドライン

#### 必須要件
すべてのクラス、メソッド、フィールドに適切なJavaDocを付与する。

#### 簡潔化基準
トークン消費を抑えるため、必要十分な情報に絞った簡潔なJavaDocを推奨する。

#### クラスレベルのJavaDoc
```java
/**
 * Minecraft ModPackの翻訳ファイルを処理するサービスクラス。
 * 複数の翻訳プロバイダーを統合して提供。
 */
public class TranslationService {
```

**簡潔化のポイント:**
- 1-2文で概要を説明
- `<p>`タグは省略
- @author、@version、@sinceは重要な場合のみ記載

#### メソッドレベルのJavaDoc
```java
/**
 * 指定されたテキストを翻訳します。
 * @param text 翻訳対象テキスト
 * @param sourceLang 元言語コード
 * @param targetLang 先言語コード
 * @param provider 翻訳プロバイダー
 * @return 翻訳されたテキスト
 * @throws TranslationException 翻訳失敗時
 */
public String translate(String text, String sourceLang, String targetLang, 
                       TranslationProvider provider) throws TranslationException {
```

**簡潔化のポイント:**
- メソッドの説明は1-2行
- @paramは各パラメータごとに1行ずつ記載（詳細説明は省略）
- @returnは簡潔に（nullの可能性などの詳細は必要時のみ）
- @throwsは主要な例外のみ記載（発生条件は簡潔に）

#### フィールドレベルのJavaDoc
```java
/** DeepL APIのAPIキー。設定ファイルから読み込み。 */
private String deeplApiKey;

/** 翻訳処理のタイムアウト時間（ミリ秒）。デフォルト30秒。 */
private static final int TIMEOUT_MS = 30000;
```

**簡潔化のポイント:**
- 1行で完結（複数行に分けない）
- 意味と制約を簡潔に記述

#### 詳細JavaDocが必要な場合
以下の場合は、簡潔版ではなく詳細なJavaDocを記述：
- 公開API（外部から利用されるクラス・メソッド）
- 複雑なアルゴリズムや重要なビジネスロジック
- パラメータの制約が多い場合
- ユーザーが明示的に詳細を要求した場合

#### 省略可能なケース
以下の場合のみJavaDocを省略可能：
- getter/setterで説明が自明な場合（ただしフィールドのJavaDocは必須）
- privateヘルパーメソッドで名前から明確に理解できる場合
- オーバーライドメソッドで親クラスのJavaDocが十分な場合（{@inheritDoc}を使用）

### 4.4 クラス設計ガイドライン

#### 基本原則
- **推奨サイズ**: 200行以下（物理行、空行・コメント含む）
- **分割検討**: 200行超過時（ただし許容条件を確認）
- **測定方法**: IDEの行番号またはファイルの総行数

#### 200行超過が適正なケース
1. **UI関連クラス**
   - Swingコンポーネントの初期化コード
   - レイアウト設定が大部分を占める場合
   - 例: `ModPackTranslatorGUI.java`, `SettingsDialog.java`

2. **統合サービスクラス**
   - 複数の密接に関連したメソッド群
   - 分割すると理解しにくくなる処理
   - 例: `TranslationService.java`（複数プロバイダーの統合）

3. **設定・定数クラス**
   - 大量の定数定義
   - 設定項目のマッピング

4. **テストクラス**
   - 包括的なテストケース

#### 分割を推奨するケース
1. **責務が明確に分離可能**
   - 例: ファイル処理とUI処理が混在

2. **独立したサブシステム**
   - 例: 翻訳処理とログ処理

3. **再利用可能なユーティリティ**
   - 例: 文字列処理、ファイル操作

4. **上記の許容条件に該当しない**

#### AI出力時の対応
- **新規クラス作成時**: 200行を目安に設計
- **既存クラス修正時**: 現在の構造を尊重
- **200行超過の追加時**: 分割の選択肢を提示

**例: 分割提案の要約形式**
```markdown
⚠️ **設計の選択肢:**

**オプションA: 既存クラスに追加**
- メリット: 集約性
- デメリット: XXX行（200行超過）

**オプションB: 新クラスに分割**
- メリット: 各クラスが小さく保守しやすい
- デメリット: ファイル数増加

どちらで実装しますか？
```

---

## 5. 実践例

### 例1: 大規模コード変更の依頼

**ユーザー:** 「TranslationServiceに新しいプロバイダーを追加」

**AI応答（要約）:**
```markdown
## 変更概要

### 影響範囲
- TranslationService.java: プロバイダー追加、翻訳メソッド実装
- SettingsDialog.java: UI要素追加

### 主要な変更点
1. TranslationProvider enumに新プロバイダー追加
2. 翻訳メソッドの実装（約80行）
3. 設定画面へのAPIキー入力欄追加

### 推定行数: 約120行

詳細コードを生成しますか？
```

---

### 例2: ドキュメント作成の依頼

**ユーザー:** 「開発環境セットアップガイドを作成」

**AI応答（目次）:**
```markdown
## 📋 ドキュメント構成案

### 開発環境セットアップガイド

### 対象読者
Java開発初心者〜中級者

### 📑 目次
1. 必要なソフトウェア
   1.1 JDK 17のインストール
   1.2 Mavenのインストール
   1.3 IDEの準備（Eclipse/IntelliJ）
2. プロジェクトのクローンとビルド
3. 依存関係の解決
4. 実行とデバッグ
5. トラブルシューティング

### 推定文字数: 約1500文字
### 推定読了時間: 5分

この構成で詳細を出力しますか？
```

---

### 例3: 小規模修正の依頼

**ユーザー:** 「バージョン番号を2.0から2.1に変更」

**AI応答（直接出力）:**
```java
// ModPackTranslatorGUI.java
setTitle("Minecraft ModPack 日本語翻訳ツール v2.1");

// pom.xml
<version>2.1.0</version>

変更完了しました。
```

---

## 6. ユーザーからの指示上書き

### 6.1 明示的な指示の優先
ユーザーから以下のような明示的な指示があった場合、このルールより優先：

- 「要約なしで直接コードを出力」
- 「全文を一度に出力」
- 「目次は不要」

### 6.2 確認の実施
ルールと矛盾する指示の場合、確認を行う：
```
「このコードは150行ほどになりますが、要約なしで直接出力しますか？」
```

---

## 7. ルールの更新履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| v2.10 | 2025-12-02 | 作業前の確認ルール追加（セクション2.3） |
| v2.9 | 2025-12-02 | トークン管理ルール追加（セクション11） |
| v2.8 | 2025-11-30 | Java 1.8 → 17 に変更（セクション4.1） |
| v2.7 | 2025-11-30 | ラムダ式の使用方針追加（セクション4.1） |
| v2.6 | 2025-11-30 | クラス・インタフェースの個別ファイル定義ルール追加（セクション4.1） |
| v2.5 | 2025-11-30 | プロジェクトルートパス追加、ファイル参照ルール拡充（セクション9） |
| v2.4 | 2025-11-30 | ファイル参照ルール追加（セクション9） |
| v2.3 | 2025-11-30 | JavaDocを簡潔版に変更（トークン節約のため） |
| v2.2 | 2025-11-30 | JavaDocガイドライン追加（セクション4.3）、クラス設計を4.4に移動 |
| v2.1 | 2025-11-30 | クラス設計ガイドライン追加（セクション4.3） |
| v2.0 | 2025-11-30 | ドキュメント生成時の要約ルール追加 |
| v1.1 | 2025-11-30 | 例外ケースの明示化 |
| v1.0 | 2025-11-30 | 初版作成 |

---

## 8. 適用範囲

### 8.1 このルールが有効な範囲
- ✅ 同一会話内では継続して適用
- ✅ プロジェクトファイルとして保存した場合、アップロードにより再適用可能

### 8.2 新しい会話での適用方法

**方法1: このファイルをアップロード**
```
新しい会話の冒頭でPROJECT_RULES.mdをアップロード
```

**方法2: カスタム指示として登録**
```
Settings → Custom Instructions に要約版を記載
```

**方法3: 口頭で指示**
```
「プロジェクトルール v2.10 を適用してください」
```

---

## 9. ファイル参照ルール

### 9.1 プロジェクトルートパス
本プロジェクトのローカルルートパス：
```
C:\Users\akasi\git\MinecraftModpackTranslator\
```

### 9.2 最新のローカルファイルを常に優先
コード生成・修正時は、必ず最新のローカルファイルを読み取ってから実施する。
会話履歴の内容は参考情報のみ。

### 9.3 必須手順
1. `filesystem:read_text_file` で対象ファイルを読み取り
2. 読み取り確認メッセージを表示
3. 最新内容を基に修正を実施

### 9.4 ファイルパスの指定方法
- **絶対パス**: `C:\Users\akasi\git\MinecraftModpackTranslator\src\main\java\TranslationService.java`
- **相対パス**: `src\main\java\TranslationService.java`（プロジェクトルートからの相対）
- **ファイル名のみ**: `TranslationService.java`（AIが `filesystem:search_files` で探索）

### 9.5 新規チャットでの初期化
新規チャット開始時の推奨手順：

#### ユーザー側
1. PROJECT_RULES.md をアップロードまたは適用を指示
2. 「プロジェクトルートは C:\Users\akasi\git\MinecraftModpackTranslator\ です」と伝える
3. または、このルールを適用すれば自動的にパスが認識される

#### AI側
1. プロジェクトルートパスを確認（このルールに記載済み）
2. 必要に応じて `filesystem:list_allowed_directories` で確認
3. `filesystem:directory_tree` でプロジェクト構造を把握
4. 作業準備完了を報告

### 9.6 ユーザー側の推奨アクション
重要な修正後は「最新ファイル確認必須」と明記して依頼。

---

## 10. 問い合わせ

このルールに関する質問や改善提案は、プロジェクトのIssuesで受け付けます。

---

## 11. トークン管理

### 11.1 残トークン警告
- チャット内の残りトークン量が **40%以下** になった場合、AIは警告を表示する
- 警告時には新しいチャットへの移行を推奨

### 11.2 警告メッセージの形式
```
⚠️ **トークン残量警告**
- 現在の残量: XX% (XXX,XXX / XXX,XXX トークン)
- 推奨アクション: 新しいチャットを開始してください
- 引き継ぎ事項: [現在の作業状況を簡潔に記載]
```

### 11.3 新チャットへの引き継ぎ
警告時、AIは以下を提供：
1. 現在の作業状況の要約
2. 次のチャットで最初に行うべきこと
3. 重要な未完了タスクのリスト

---

**文書バージョン:** 2.10  
**最終更新日:** 2025年12月02日  
**管理者:** プロジェクトチーム
